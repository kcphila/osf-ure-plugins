{% extends 'import/baseimport.html' %}

{% block javascript %}
{{ super() }}
{# Our Custom Javascript Client for Google's API #}
<script type="text/javascript" src="{{ url_for('static', filename='js/googleauth.js') }}"></script>
{% endblock %}

{% block import_content %}
<div class="form-item">
    <label class="form-label" for="google-document-name">Google Document</label>
    <!-- This html is intended to be used with osf-project-select.js, which must be added to the header manually -->
    {% include "partials/googleauth-widget.html" %}
    <div class="google-login-required">
        <input type="hidden" name="google-document-id" value="" id="google-document-id" />
        <input type="text" name="google-document-name" class="form-input autocomplete-panel" value="" id="google-document-name" />
        <input type="checkbox" name="google-include-shared" id="google-include-shared" /><span title="If you want to search for a document in a Shared Drive, check here">Use Shared Drives</span>            
        <span id="google-project-fetch-info" class="help-text" ></span>
        <div class="help-text">Start typing the Google Document and select it when it appears. Check <i>Use Shared Drives</i> if you have a <b>dedicated</b> Shared/Team Drive - this doesn't apply to files simply shared with others. </div>
    </div>
</div>
<script>
$(document).ready(function () {
    //
    // Set up the autocomplete
    //
    $('#google-document-name').autocomplete({
        minLength: 3,
        source: function(req, setData){
            $.ajax({
                url: "/google/getfiles",
                method: "POST",
                dataType: "json",
                data: {
                    'name_contains': req.term,
                    'all_drives': $('#google-include-shared').prop('checked'),
                },
                success: function(data) {                
                    if(data.error || data.errors)
                        ureAjaxError(data);
                    else if(data.result_count_exceeded){
                        return; // this happens when there are more than 50 results.  Keep typing, friends, keep typing.
                    }
                    else{
                        console.log("Google Files Search for " + req.term);
                        console.log(data);
                        var results = [];
                        data.forEach(function(fref){
                            results.push({value: fref.name, id: fref.id});
                        });
                        setData(results);
                    }
                },
                error: ureAjaxError
            });   
        },
        select: function(event, ui){
            // set the id to the hidden field            
            $('#google-document-id').val(ui.item.id);            
        }
    });

    //
    // Check to see if we're already authenticated
    //
    

});
</script>
{% endblock %}